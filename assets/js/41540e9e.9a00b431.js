"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4530],{6259:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var a=n(3117),i=(n(7294),n(3905));const o={title:"Audit Logs",description:"Guide for Audit Logs",tags:["settings","audit-logs"]},r="Audit Logs",s={unversionedId:"docs/core/admin/ee/audit-logs",id:"docs/core/admin/ee/audit-logs",title:"Audit Logs",description:"Guide for Audit Logs",source:"@site/docs/docs/01-core/admin/01-ee/02-audit-logs.md",sourceDirName:"docs/01-core/admin/01-ee",slug:"/docs/core/admin/ee/audit-logs",permalink:"/docs/core/admin/ee/audit-logs",draft:!1,editUrl:"https://github.com/strapi/strapi/tree/main/docs/docs/docs/01-core/admin/01-ee/02-audit-logs.md",tags:[{label:"settings",permalink:"/tags/settings"},{label:"audit-logs",permalink:"/tags/audit-logs"}],version:"current",sidebarPosition:2,frontMatter:{title:"Audit Logs",description:"Guide for Audit Logs",tags:["settings","audit-logs"]},sidebar:"docs",previous:{title:"Review Workflows",permalink:"/docs/core/admin/ee/review-workflows"},next:{title:"useLicenseLimits",permalink:"/docs/core/admin/ee/hooks/use-license-limits"}},l={},d=[{value:"Summary",id:"summary",level:2},{value:"Backend design",id:"backend-design",level:2},{value:"Audit Logs Local Provider",id:"audit-logs-local-provider",level:3},{value:"Content types",id:"content-types",level:3},{value:"strapi_audit_logs",id:"strapi_audit_logs",level:4},{value:"Subscribing to all events",id:"subscribing-to-all-events",level:3},{value:"Retention days",id:"retention-days",level:3},{value:"Audit Logs format",id:"audit-logs-format",level:3}],u={toc:d};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"audit-logs"},"Audit Logs"),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"Audit Logs provide a way to view the history of all user actions at Admin API level. This includes actions related to entries (including publish actions), media (including its folders), users, login & logout of admin users, components, roles, and permissions, you can see the list of all the default events ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/strapi/strapi/blob/main/packages/core/admin/ee/server/services/audit-logs.js#L9"},"here"),"."),(0,i.kt)("h2",{id:"backend-design"},"Backend design"),(0,i.kt)("p",null,"The Audit Logs feature was built to take advantage of the eventHub. You can find the service and its core code at ",(0,i.kt)("inlineCode",{parentName:"p"},"packages/core/admin/ee/server/services"),"."),(0,i.kt)("h3",{id:"audit-logs-local-provider"},"Audit Logs Local Provider"),(0,i.kt)("p",null,"To save audit log data, we utilize an Audit Logs local provider responsible for interacting with the database. This provider should return an object with a ",(0,i.kt)("inlineCode",{parentName:"p"},"register")," function, and this function should return an object with functions to handle ",(0,i.kt)("inlineCode",{parentName:"p"},"saveEvent"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"findMany"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"findOne"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"deleteExpiredEvents"),"."),(0,i.kt)("h3",{id:"content-types"},"Content types"),(0,i.kt)("h4",{id:"strapi_audit_logs"},"strapi_audit_logs"),(0,i.kt)("p",null,"This content type stores all the audit logs. For each allowed event, we save an entry in the audit logs content type."),(0,i.kt)("h3",{id:"subscribing-to-all-events"},"Subscribing to all events"),(0,i.kt)("p",null,"The Audit Logs feature adds a subscriber to the ",(0,i.kt)("a",{parentName:"p",href:"/docs/core/strapi/event-hub"},"EventHub"),", allowing it to listen to all events in the application. However, we don't save every event in the audit logs; we only save the default ones (see the defaultEvents array in the service file)."),(0,i.kt)("h3",{id:"retention-days"},"Retention days"),(0,i.kt)("p",null,"As the number of events in our Audit Logs can grow significantly, we run a daily job at midnight to delete logs that are older than the retention days defined."),(0,i.kt)("p",null,"By default, the retention days are set to 90 days, but this value can be changed. For enterprise self-hosted projects, users can set a configuration variable (admin.auditLogs.retentionDays) and use that one."),(0,i.kt)("p",null,"For cloud projects, the retention days are determined by the license. In a cloud project, users can set a custom retention days in the configuration, but this value cannot exceed the retention days defined by the license."),(0,i.kt)("p",null,"In both cases, if we want to set a custom retention days we can modify the Admin Panel API config file (",(0,i.kt)("inlineCode",{parentName:"p"},"./config/admin.js"),"). You can find all the possible options as well as other configurations for the Admin Panel on the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.strapi.io/dev-docs/configurations/admin-panel#available-options"},"documentation page"),"."),(0,i.kt)("h3",{id:"audit-logs-format"},"Audit Logs format"),(0,i.kt)("p",null,"Every Audit Log has the following format:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"type Event {\n  action: string, // Name of the event\n  date: Date, // When the event happens\n  userId: number, // Id of the user that trigger the event\n  payload?: Object, // Extra info of the event\n};\n")),(0,i.kt)("p",null,"To understand how we obtain this information, we need to know how we emit an event with the Event Hub. To emit an event, we use the following function: (To see more info about the EventHub, click ",(0,i.kt)("a",{parentName:"p",href:"/docs/core/strapi/event-hub"},"here")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"strapi.eventHub.emit(name: Pick<Event, 'name'>, payload: Pick<Event, 'payload'>);\n")),(0,i.kt)("p",null,"First, we check the event is coming from admin requests and it's on our ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/strapi/strapi/blob/main/packages/core/admin/ee/server/services/audit-logs.js#L9"},"default events")," list, then when creating our Audit Log, we retrieve the action and payload from this emitted event, where the first argument is the action or event name, and the second one is the payload. We obtain the user from the requestContext."))}c.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=d(n),m=i,g=p["".concat(l,".").concat(m)]||p[m]||c[m]||o;return n?a.createElement(g,r(r({ref:t},u),{},{components:n})):a.createElement(g,r({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var d=2;d<o;d++)r[d]=n[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);